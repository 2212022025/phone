<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate HTML Phone - Play Store Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --phone-border: #1a1a1a;
            --accent-color: #3498db;
            --text-color: #333;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #dce1e6;
            margin: 0;
            overflow: hidden;
        }

        /* Phone Hardware */
        .phone {
            width: 350px;
            height: 700px;
            background-color: var(--phone-border);
            border-radius: 45px;
            padding: 12px;
            box-shadow: 25px 25px 70px #a6aab0, -25px -25px 70px #ffffff;
            position: relative;
            z-index: 1;
        }

        .screen {
            width: 100%;
            height: 100%;
            /* Home Screen Wallpaper */
            background: url('https://files.catbox.moe/d9bnza.jpg') no-repeat center center/cover;
            border-radius: 35px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Black Screen (Sleep Mode) */
        #black-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #080808; 
            z-index: 9999;
            display: none;
            background-image: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 40%);
        }

        /* Boot/Restart Screen */
        #boot-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 9998;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        /* Swipe Down Trigger Zone */
        .swipe-trigger {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 50px;
            z-index: 2100;
        }

        /* Notch */
        .notch {
            position: absolute;
            top: 0; left: 50%;
            transform: translateX(-50%);
            width: 140px; height: 28px;
            background-color: var(--phone-border);
            border-bottom-left-radius: 18px; border-bottom-right-radius: 18px;
            z-index: 2000; pointer-events: none;
        }

        /* Status Bar */
        .status-bar {
            height: 35px; width: 100%;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 25px; color: white; font-size: 13px; font-weight: 600;
            z-index: 1900; position: relative; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .status-left {
            display: flex; align-items: center; gap: 5px;
        }

        .status-icons { display: flex; gap: 8px; }
        .status-icons i { display: none; } 
        .status-icons i.visible { display: inline-block; }
        /* Bolt specific styling */
        #stat-bolt { display: none; color: yellow; font-size: 11px; margin-left: 2px; }
        #stat-bolt.visible { display: inline-block; }

        /* Control Center */
        .control-center {
            position: absolute; top: -100%; left: 10px; right: 10px; height: 320px;
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(20px);
            border-radius: 0 0 25px 25px; z-index: 1800;
            transition: top 0.4s cubic-bezier(0.2, 0, 0, 1);
            padding: 50px 20px 20px 20px;
            display: flex; flex-direction: column; color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .control-center.open { top: 0; }

        .cc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .cc-item { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .cc-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255,255,255,0.15);
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; cursor: pointer; transition: 0.2s;
        }
        .cc-btn.active { background: #3498db; color: white; }
        .cc-btn.active.torch-on { background: #f1c40f; color: #000; }
        .cc-label { font-size: 11px; color: #ccc; }

        /* Lock Screen Container */
        .lock-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; overflow: hidden;
            transition: transform 0.5s cubic-bezier(0.7, 0, 0.3, 1);
            background-color: #000; 
            background-image: url('https://files.catbox.moe/0ah2k3.jpg');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover;
        }
        .lock-container.unlocked { transform: translateY(-100%); }

        /* Lock Screen - Main View */
        .lock-main {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.15);
            display: flex; flex-direction: column; align-items: center;
            padding-top: 100px;
            color: white;
            transition: transform 0.4s ease-in-out, opacity 0.4s;
        }
        .lock-main.slide-up { transform: translateY(-100%); opacity: 0; }

        .big-time { font-size: 85px; font-weight: 400; letter-spacing: -2px; text-shadow: 0 4px 10px rgba(0,0,0,0.3); line-height: 1; }
        .big-date { font-size: 20px; font-weight: 500; margin-top: 10px; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        .swipe-hint {
            position: absolute; bottom: 30px; width: 100%;
            text-align: center; font-size: 14px; color: rgba(255,255,255,0.8);
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }

        /* Lock Screen - PIN Pad View */
        .lock-pad {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(20px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1);
            color: white;
        }
        .lock-pad.active { transform: translateY(0); }

        .pin-dots { display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; height: 15px;}
        .dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; transition: 0.2s; }
        .dot.filled { background: white; }

        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
        .key {
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(255,255,255,0.15);
            display: flex; justify-content: center; align-items: center;
            font-size: 26px; cursor: pointer; transition: 0.2s;
        }
        .key:active { background: rgba(255,255,255,0.4); }
        .cancel-pin { margin-top: 20px; font-size: 14px; cursor: pointer; opacity: 0.8; }

        /* Home Screen */
        .home-screen {
            flex: 1; padding: 50px 20px 20px 20px;
            display: grid; grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: min-content; gap: 20px 10px;
            z-index: 10; overflow-y: auto;
        }

        .app-icon-wrapper {
            display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; position: relative;
        }
        .app-icon-wrapper:active { transform: scale(0.9); }
        /* Edit Mode Styles */
        .home-screen.edit-mode .app-icon-wrapper {
            animation: shake-icon 0.3s infinite;
        }
        @keyframes shake-icon {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(2deg); }
            75% { transform: rotate(-2deg); }
            100% { transform: rotate(0deg); }
        }
        .delete-badge {
            position: absolute; top: -5px; left: -5px; width: 20px; height: 20px;
            background: red; color: white; border-radius: 50%;
            display: none; justify-content: center; align-items: center;
            font-size: 12px; z-index: 5;
        }
        .home-screen.edit-mode .delete-badge { display: flex; }
        .move-badge {
             position: absolute; top: -5px; right: -5px; width: 20px; height: 20px;
            background: blue; color: white; border-radius: 50%;
            display: none; justify-content: center; align-items: center;
            font-size: 12px; z-index: 5;
        }
        /* Only show move badge if we implement swap visual cues, for now click to swap */

        .app-icon {
            width: 55px; height: 55px; border-radius: 14px;
            display: flex; justify-content: center; align-items: center;
            font-size: 26px; color: white; margin-bottom: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background-size: cover; background-position: center;
        }
        .app-name { font-size: 11px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.8); text-align: center; white-space: nowrap; overflow: hidden; width: 100%; text-overflow: ellipsis;}

        /* App Icon Colors/Images */
        .c-browser { background: linear-gradient(135deg, #2980b9, #6dd5fa); }
        .c-notes { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .c-calc { background: linear-gradient(135deg, #34495e, #2c3e50); }
        .c-camera { background: linear-gradient(135deg, #dd2476, #ff512f); }
        .c-gallery { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .c-settings { background: linear-gradient(135deg, #7F7FD5, #86A8E7); }
        .c-phone { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .c-chrome { background: white; color: #4285F4; border: 1px solid #ddd; }
        .c-yt { background: #FF0000; color: white; }
        .c-playstore { background: white; position: relative; overflow: hidden; }
        .c-playstore::after { 
            content: ''; position: absolute; width: 0; height: 0; 
            border-left: 20px solid #00d2ff; border-top: 12px solid transparent; border-bottom: 12px solid transparent; 
            transform: translateX(2px);
        }

        /* App Window */
        .app-window {
            position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 55px);
            background: #fff; z-index: 500;
            display: flex; flex-direction: column;
            transform: scale(0.8); opacity: 0; pointer-events: none;
            transition: 0.3s cubic-bezier(0.2, 0, 0, 1);
            border-radius: 35px 35px 0 0; overflow: hidden;
        }
        .app-window.active { transform: scale(1); opacity: 1; pointer-events: all; }

        .app-header {
            height: 75px; background: #f8f9fa; display: flex; align-items: flex-end;
            padding: 10px 20px; font-weight: bold; border-bottom: 1px solid #ddd;
        }
        .app-content { flex: 1; overflow: hidden; position: relative; }

        /* Toast Notification */
        .toast {
            position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 10px 20px; border-radius: 20px; font-size: 14px;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 2000;
        }
        .toast.show { opacity: 1; }

        /* Recents Screen */
        .recents-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 55px);
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            z-index: 800; display: flex; gap: 20px; padding: 0 40px;
            align-items: center; overflow-x: auto;
            opacity: 0; pointer-events: none; transition: 0.2s;
        }
        .recents-screen.active { opacity: 1; pointer-events: all; }
        
        .recent-card {
            min-width: 220px; height: 400px;
            background: white; border-radius: 20px;
            position: relative; display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: 0.3s; overflow: hidden;
        }
        
        .recent-header { padding: 10px; background: #eee; display: flex; align-items: center; gap: 10px; font-size: 12px; font-weight: bold;}
        .recent-body { flex: 1; background: #ddd; display: flex; justify-content: center; align-items: center; font-size: 40px; color: #999; cursor: pointer; }
        
        .close-recent {
            position: absolute; top: 5px; right: 5px;
            width: 25px; height: 25px; background: #ff5f56; color: white;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 2;
        }
        .slide-up-remove { animation: slideUpOut 0.3s forwards; }
        @keyframes slideUpOut { to { transform: translateY(-100%); opacity: 0; } }

        /* Navigation */
        .nav-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 55px;
            background: rgba(0,0,0,0.9);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1950; border-radius: 0 0 35px 35px;
        }
        .nav-btn { color: #aaa; font-size: 20px; padding: 15px; cursor: pointer; }
        .nav-btn:active { color: white; }

        /* Play Store Styles */
        .store-list { padding: 10px; overflow-y: auto; height: 100%; background: #f0f0f0; }
        .store-item { 
            background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px; 
            display: flex; gap: 10px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .store-icon { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; background: #ddd; }
        .store-info { flex: 1; display: flex; flex-direction: column; }
        .store-title { font-weight: bold; font-size: 14px; margin-bottom: 2px; }
        .store-size { font-size: 11px; color: #666; }
        .store-action {
            padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: bold; border: none; cursor: pointer;
            transition: 0.2s; white-space: nowrap;
        }
        .btn-install { background: #01875f; color: white; }
        .btn-install:active { background: #016b4b; }
        .btn-play { background: #2ecc71; color: white; }
        .btn-pause { background: #f39c12; color: white; }
        .btn-cancel { background: #e74c3c; color: white; margin-left: 5px; }
        
        .progress-container { width: 100%; height: 4px; background: #eee; border-radius: 2px; margin-top: 5px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background: #01875f; width: 0%; transition: width 0.5s linear; }

        /* Specific App Styles */
        .browser-bar { padding: 8px; background: #eee; display: flex; gap: 5px; }
        .url-box { flex: 1; border: 1px solid #ccc; border-radius: 15px; padding: 4px 10px; font-size: 12px; }
        .note-area { width: 100%; height: 100%; border: none; padding: 20px; font-size: 16px; background: #fffde7; resize: none; outline: none; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-10px);} 75% {transform: translateX(10px);} }

        /* Free Fire Intent Screen */
        .ff-launch-screen {
            background: linear-gradient(135deg, #000428, #004e92);
            color: white; height: 100%; display: flex; align-items: center; justify-content: center;
        }
        .ff-btn {
            padding: 18px 36px; font-size: 20px; border: none; border-radius: 12px;
            background: #facc15; color: #000; font-weight: bold; cursor: pointer;
        }
        .ff-btn:active { transform: scale(0.96); }

        /* FIX: In-Call Screen Styles - Ensures it appears when active */
        .incall-screen {
            display: none; /* Default hidden */
        }
        .incall-screen.active { 
            display: flex !important; /* Force visible when active */
        }

    </style>
</head>
<body>

<div class="phone">
    
    <div class="screen" id="screen">

        <!-- Boot/Restart Overlay -->
        <div id="boot-screen">
            <i class="fas fa-mobile-alt fa-3x" style="margin-bottom: 20px;"></i>
            <h3 id="boot-text">Restarting...</h3>
            <div style="width: 50px; height: 50px; border: 3px solid #333; border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>

        <!-- Black Screen (Sleep) -->
        <div id="black-screen"></div>
        
        <!-- Swipe triggers -->
        <div class="swipe-trigger" id="swipe-area"></div>
        <div class="notch"></div>

        <!-- Status Bar -->
        <div class="status-bar" id="status-bar-el">
            <div class="status-left">
                <span id="clock-small">12:00</span>
                <!-- Power Saving Icon here (Right of time) -->
                <i class="fas fa-bolt" id="stat-bolt"></i>
            </div>
            
            <div class="status-icons">
                <i class="fas fa-wifi" id="stat-wifi"></i>
                <i class="fas fa-plane" id="stat-plane"></i>
                <i class="fas fa-signal" id="stat-data"></i>
                <i class="fas fa-bluetooth-b" id="stat-bt"></i>
                <i class="fas fa-battery-three-quarters"></i>
            </div>
        </div>

        <!-- Control Center -->
        <div class="control-center" id="control-center">
            <h3 style="margin-top:0">Control Center</h3>
            <div class="cc-grid">
                <div class="cc-item">
                    <div class="cc-btn active" id="btn-wifi" onclick="toggleSetting('wifi')"><i class="fas fa-wifi"></i></div>
                    <span class="cc-label">Wi-Fi</span>
                </div>
                <div class="cc-item">
                    <div class="cc-btn active" id="btn-data" onclick="toggleSetting('data')"><i class="fas fa-signal"></i></div>
                    <span class="cc-label">Data</span>
                </div>
                <div class="cc-item">
                    <div class="cc-btn" id="btn-plane" onclick="toggleSetting('plane')"><i class="fas fa-plane"></i></div>
                    <span class="cc-label">Flight</span>
                </div>
                <div class="cc-item">
                    <div class="cc-btn" id="btn-bt" onclick="toggleSetting('bt')"><i class="fab fa-bluetooth-b"></i></div>
                    <span class="cc-label">BT</span>
                </div>
                <div class="cc-item">
                    <div class="cc-btn" id="btn-flash" onclick="toggleSetting('flash')"><i class="fas fa-bolt"></i></div>
                    <span class="cc-label">Torch</span>
                </div>
                <div class="cc-item">
                    <div class="cc-btn" id="btn-save" onclick="toggleSetting('save')"><i class="fas fa-leaf"></i></div>
                    <span class="cc-label">Saver</span>
                </div>
            </div>
            <div style="margin-top: auto; text-align: center; color: #888;">
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>

        <!-- NEW LOCK SCREEN -->
        <div class="lock-container" id="lock-screen">
            <div class="lock-main" id="lock-main">
                <div class="big-date" id="lock-date">Wednesday, Jan 28</div>
                <div class="big-time" id="lock-time">6:47</div>
                <div class="swipe-hint">Swipe up to unlock</div>
                <div style="position: absolute; bottom:0; left:0; width:100%; height:200px;" id="lock-swipe-zone"></div>
            </div>

            <div class="lock-pad" id="lock-pad">
                <div style="margin-bottom: 20px; font-size: 16px;">Enter PIN</div>
                <div class="pin-dots">
                    <div class="dot" id="p1"></div>
                    <div class="dot" id="p2"></div>
                    <div class="dot" id="p3"></div>
                    <div class="dot" id="p4"></div>
                </div>
                <div class="keypad">
                    <div class="key" onclick="pinIn(1)">1</div>
                    <div class="key" onclick="pinIn(2)">2</div>
                    <div class="key" onclick="pinIn(3)">3</div>
                    <div class="key" onclick="pinIn(4)">4</div>
                    <div class="key" onclick="pinIn(5)">5</div>
                    <div class="key" onclick="pinIn(6)">6</div>
                    <div class="key" onclick="pinIn(7)">7</div>
                    <div class="key" onclick="pinIn(8)">8</div>
                    <div class="key" onclick="pinIn(9)">9</div>
                    
                    <div class="key" onclick="pinIn('C')"><i class="fas fa-backspace"></i></div>
                    <div class="key" onclick="pinIn(0)">0</div>
                    <div class="key" onclick="pinIn('CHECK')"><i class="fas fa-check"></i></div>
                </div>
                <div class="cancel-pin" onclick="closePinPad()">Cancel</div>
            </div>
        </div>

        <!-- Home Screen (Generated by JS) -->
        <div class="home-screen" id="home-screen"></div>

        <!-- Recents View -->
        <div class="recents-screen" id="recents-view" onclick="checkRecentsClick(event)"></div>

        <!-- APP WINDOWS -->
        
        <!-- App: Phone -->
        <div class="app-window" id="app-phone">
            <div class="app-header">Phone</div>
            <div class="app-content">
                <!-- Phone App Content -->
                <div style="display: grid; grid-template-rows: 1fr 2fr; height: 100%;">
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 32px; color: #333; padding: 20px;">
                        <div id="dial-number" style="min-height: 40px;"></div>
                        <div style="font-size: 14px; margin-top: 10px; background: #eee; padding: 5px 15px; border-radius: 15px; cursor: pointer;" onclick="dialModi()">
                            <i class="fas fa-user"></i> Saved: Modi Ji
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px;">
                        <!-- Keypad generated in JS or reused -->
                        <div class="p-key" onclick="dialKey('1')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">1</div>
                        <div class="p-key" onclick="dialKey('2')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">2</div>
                        <div class="p-key" onclick="dialKey('3')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">3</div>
                        <div class="p-key" onclick="dialKey('4')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">4</div>
                        <div class="p-key" onclick="dialKey('5')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">5</div>
                        <div class="p-key" onclick="dialKey('6')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">6</div>
                        <div class="p-key" onclick="dialKey('7')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">7</div>
                        <div class="p-key" onclick="dialKey('8')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">8</div>
                        <div class="p-key" onclick="dialKey('9')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">9</div>
                        <div class="p-key" onclick="dialKey('*')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">*</div>
                        <div class="p-key" onclick="dialKey('0')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">0</div>
                        <div class="p-key" onclick="dialKey('#')" style="display:flex; justify-content:center; align-items:center; background:#f0f0f0; border-radius:50%; width:60px; height:60px; margin:0 auto; font-size:20px;">#</div>
                        <div onclick="startCall()" style="grid-column: span 3; background: #2ecc71; color: white; border-radius: 30px; display: flex; justify-content: center; align-items: center; height: 60px; width: 60px; margin: 0 auto; font-size: 24px; cursor: pointer;"><i class="fas fa-phone"></i></div>
                    </div>
                </div>
            </div>
            <!-- In-Call Screen Overlay -->
            <div class="incall-screen" id="incall-screen" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, #2c3e50, #000); z-index: 10; display: none; flex-direction: column; align-items: center; justify-content: space-around; padding: 50px 0; color: white;">
                <div class="avatar" style="width: 100px; height: 100px; background: #95a5a6; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 40px;"><i class="fas fa-user"></i></div>
                <h2 id="call-name">Unknown</h2>
                <div id="call-status">Calling...</div>
                <div class="end-call-btn" onclick="endCall()" style="width: 70px; height: 70px; border-radius: 50%; background: #e74c3c; display: flex; justify-content: center; align-items: center; font-size: 30px; cursor: pointer;"><i class="fas fa-phone-slash"></i></div>
            </div>
        </div>

        <!-- App: Play Store -->
        <div class="app-window" id="app-playstore">
            <div class="app-header" style="background:#fff; border-bottom:1px solid #ddd; padding:15px; align-items:center;">
                <i class="fab fa-google-play" style="color:#00d2ff; font-size:20px; margin-right:10px;"></i> Play Store
            </div>
            <div class="app-content">
                <div class="store-list" id="store-list-container">
                    <!-- Store items injected via JS -->
                </div>
            </div>
        </div>

        <!-- App: Chrome -->
        <div class="app-window" id="app-chrome">
            <div class="app-header" style="height:auto; display:block; padding:0;">
                <div style="height:35px;"></div>
                <div class="browser-bar">
                    <input class="url-box" placeholder="Search Google..." id="chrome-search-input">
                    <i class="fas fa-search" style="padding: 5px; cursor:pointer;" onclick="searchGoogle()"></i>
                </div>
            </div>
            <div class="app-content">
                <embed id="chrome-frame" style="width:100%; height:100%; border:none;" src="https://www.google.com/search?igu=1"></embed>
            </div>
        </div>

        <!-- App: YouTube -->
        <div class="app-window" id="app-youtube">
            <div class="app-header" style="background:#ff0000; color:white; height:75px; align-items:center; padding-top:25px; display: flex;">
                <i class="fab fa-youtube" style="margin-right: 10px;"></i> YouTube
            </div>
            <div class="app-content">
                <div class="yt-player-box" id="yt-player-box" style="position: sticky; top: 0; background: #000; width: 100%; aspect-ratio: 16/9; z-index: 100; display: none;">
                    <iframe id="yt-player" width="100%" height="100%" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
                <div class="yt-feed" id="yt-feed" style="overflow-y: auto; height: 100%; background: #f1f1f1; padding: 0;"></div>
            </div>
        </div>

        <!-- App: Browser -->
        <div class="app-window" id="app-browser">
            <div class="app-header" style="height:auto; display:block; padding:0;">
                <div style="height:35px;"></div>
                <div class="browser-bar">
                    <input class="url-box" value="https://en.m.wikipedia.org" id="browser-url">
                    <i class="fas fa-arrow-right" style="padding: 5px;" onclick="loadBrowser()"></i>
                </div>
            </div>
            <div class="app-content">
                <iframe id="browser-frame" style="width:100%; height:100%; border:none;" src="https://en.m.wikipedia.org/wiki/Special:Random"></iframe>
            </div>
        </div>

        <!-- App: Notepad -->
        <div class="app-window" id="app-notepad">
            <div class="app-header">
                Notepad <i class="fas fa-save" style="margin-left:auto; cursor: pointer;" onclick="saveNote()"></i>
            </div>
            <div class="app-content">
                <textarea class="note-area" id="note-input" placeholder="Type here..."></textarea>
            </div>
        </div>
        <div class="toast" id="toast-msg">Saved!</div>

        <!-- App: Calculator -->
        <div class="app-window" id="app-calc">
            <div class="app-header">Calculator</div>
            <div class="app-content" style="display:flex; flex-direction:column;">
                <div style="flex:1; background:#222; color:white; font-size:40px; display:flex; align-items:end; justify-content:end; padding:20px;" id="calc-display">0</div>
                <div style="display:grid; grid-template-columns:repeat(4,1fr); height:60%;">
                    <!-- Calc Buttons -->
                    <button style="font-size:20px;" onclick="calc('C')">C</button>
                    <button style="font-size:20px;" onclick="calc('/')">/</button>
                    <button style="font-size:20px;" onclick="calc('*')">*</button>
                    <button style="font-size:20px;" onclick="calc('DEL')"><</button>
                    <button style="font-size:20px;" onclick="calc('7')">7</button>
                    <button style="font-size:20px;" onclick="calc('8')">8</button>
                    <button style="font-size:20px;" onclick="calc('9')">9</button>
                    <button style="font-size:20px; background:orange; color:white;" onclick="calc('-')">-</button>
                    <button style="font-size:20px;" onclick="calc('4')">4</button>
                    <button style="font-size:20px;" onclick="calc('5')">5</button>
                    <button style="font-size:20px;" onclick="calc('6')">6</button>
                    <button style="font-size:20px; background:orange; color:white;" onclick="calc('+')">+</button>
                    <button style="font-size:20px;" onclick="calc('1')">1</button>
                    <button style="font-size:20px;" onclick="calc('2')">2</button>
                    <button style="font-size:20px;" onclick="calc('3')">3</button>
                    <button style="font-size:20px; background:orange; color:white;" onclick="calc('=')">=</button>
                    <button style="font-size:20px; grid-column:span 2;" onclick="calc('0')">0</button>
                    <button style="font-size:20px;" onclick="calc('.')">.</button>
                </div>
            </div>
        </div>

        <!-- App: Camera -->
        <div class="app-window" id="app-camera">
            <div class="app-content" style="background:black; display: flex; flex-direction: column;">
                <video id="cam-feed" autoplay playsinline style="flex: 1;"></video>
                <canvas id="cam-canvas" style="display:none;"></canvas>
                <div style="height: 100px; background:black; position: relative; display:flex; justify-content:center; align-items:center;">
                     <div style="width:60px; height:60px; border:4px solid white; border-radius:50%; background:rgba(255,255,255,0.2); cursor:pointer;" onclick="snap()"></div>
                </div>
            </div>
        </div>
        
        <!-- App: Gallery -->
        <div class="app-window" id="app-gallery">
            <div class="app-header">Gallery</div>
            <div class="app-content">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; overflow-y: auto; max-height: 100%;" id="gallery-container"></div>
            </div>
        </div>
        
        <!-- App: Settings -->
        <div class="app-window" id="app-settings">
            <div class="app-header">Settings</div>
            <div class="app-content" style="padding:20px; display:flex; flex-direction:column; gap:15px; overflow-y: auto;">
                <h3>Phone Info</h3>
                <p>Model:  iPhone 18 Pro Max</p>
                <p>System: Android 16 Pro</p>
                <p><strong>Storage: 512 GB</strong></p>
                <p><strong>RAM: 8 GB</strong></p>
                
                <hr style="width:100%; border:0; border-top:1px solid #ddd;">
                
                <div id="pin-setting-area">
                    <h4 style="margin:0 0 5px 0">Security</h4>
                    <input type="password" id="curr-pin-val" maxlength="4" placeholder="Enter Current PIN" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-bottom:5px;">
                    <input type="password" id="new-pin-val" maxlength="4" placeholder="Enter New 4-Digit PIN" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-bottom:5px;">
                    <button onclick="changeSystemPin()" style="width:100%; padding:10px; background:#2ecc71; color:white; border:none; border-radius:8px; cursor:pointer;">Update Lock PIN</button>
                </div>

                <hr style="width:100%; border:0; border-top:1px solid #ddd;">
                
                <button onclick="triggerRestart(false)" style="padding:15px; background:#3498db; color:white; border:none; border-radius:10px; font-size:16px;">
                    <i class="fas fa-redo"></i> Restart Phone
                </button>
                
                <button onclick="triggerRestart(true)" style="padding:15px; background:#e74c3c; color:white; border:none; border-radius:10px; font-size:16px;">
                    <i class="fas fa-trash"></i> Factory Reset
                </button>
            </div>
        </div>

        <!-- Generic Game Frame Container (Used for games) -->
        <div class="app-window" id="app-generic-frame">
            <div class="app-header" id="generic-header">Game</div>
            <div class="app-content" id="generic-content"></div>
        </div>

        <!-- 3 Button Navigation -->
        <div class="nav-bar">
            <div class="nav-btn" onclick="navBack()"><i class="fas fa-chevron-left"></i></div>
            <div class="nav-btn" onclick="navHome()"><i class="fas fa-circle"></i></div>
            <div class="nav-btn" onclick="navRecents()"><i class="fas fa-square"></i></div>
        </div>
    </div>
</div>

<style>
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
    /* --- SYSTEM DATA --- */
    let state = {
        wifi: true,
        data: true,
        plane: false,
        bt: false,
        flash: false,
        save: false,
        systemPin: "2026"
    };

    // Store Content Definition
    const storeApps = [
        {
            id: 'ura',
            name: 'URA APP',
            sizeMB: 13,
            iconImg: 'https://files.catbox.moe/zvz7xi.png',
            url: 'https://2212022025.github.io/Uraapp/',
            type: 'iframe'
        },
        {
            id: 'car',
            name: 'Car Simulator',
            sizeMB: 5,
            iconIcon: 'fas fa-car', // Fallback if no image
            bgColor: '#e74c3c',
            url: 'https://2212022025.github.io/Car-Game/',
            type: 'iframe'
        },
        {
            id: 'freefire',
            name: 'Free Fire Max',
            sizeMB: 382,
            iconImg: 'https://files.catbox.moe/un14gh.jpg',
            type: 'intent'
        }
    ];

    // Default System Apps
    const defaultApps = [
        { id: 'phone', name: 'Phone', icon: 'fa-phone', color: 'c-phone' },
        { id: 'playstore', name: 'Play Store', icon: 'fab fa-google-play', color: 'c-playstore' },
        { id: 'chrome', name: 'Chrome', icon: 'fab fa-chrome', color: 'c-chrome' },
        { id: 'youtube', name: 'YouTube', icon: 'fab fa-youtube', color: 'c-yt' },
        { id: 'browser', name: 'Browser', icon: 'fa-globe', color: 'c-browser' },
        { id: 'notepad', name: 'Notepad', icon: 'fa-sticky-note', color: 'c-notes' },
        { id: 'calc', name: 'Calculator', icon: 'fa-calculator', color: 'c-calc' },
        { id: 'camera', name: 'Camera', icon: 'fa-camera', color: 'c-camera' },
        { id: 'gallery', name: 'Gallery', icon: 'fa-images', color: 'c-gallery' },
        { id: 'settings', name: 'Settings', icon: 'fa-cog', color: 'c-settings' }
    ];

    // Installed Apps List (Starts with default)
    let installedApps = [...defaultApps];
    
    // Download Management
    let activeDownloads = {}; // Key: appId, Value: { progress, timerId }
    const DOWNLOAD_SPEED_MBPS = 2; // 2MB per second

    let recentAppsList = [];
    let galleryPhotos = [];

    // Edit Mode State
    let isEditMode = false;
    let editModeTimer = null;
    let selectedForSwap = null; // For simple move logic

    /* --- PERSISTENCE HELPERS --- */
    function saveSystem() {
        localStorage.setItem('sys_installed_apps', JSON.stringify(installedApps));
        localStorage.setItem('sys_gallery', JSON.stringify(galleryPhotos));
        localStorage.setItem('sys_state', JSON.stringify(state));
        localStorage.setItem('sys_recents', JSON.stringify(recentAppsList));
    }

    function loadSystem() {
        const savedApps = localStorage.getItem('sys_installed_apps');
        if(savedApps) installedApps = JSON.parse(savedApps);

        const savedPhotos = localStorage.getItem('sys_gallery');
        if(savedPhotos) galleryPhotos = JSON.parse(savedPhotos);

        const savedState = localStorage.getItem('sys_state');
        if(savedState) {
            const parsed = JSON.parse(savedState);
            state = {...state, ...parsed};
        }
        
        const savedRecents = localStorage.getItem('sys_recents');
        if(savedRecents) recentAppsList = JSON.parse(savedRecents);
    }

    /* --- INITIALIZATION --- */
    window.onload = function() {
        loadSystem();
        renderHomeScreen();
        updateUI();
        updateClock();
    };

    /* --- HOME SCREEN RENDERER --- */
    function renderHomeScreen() {
        const grid = document.getElementById('home-screen');
        grid.innerHTML = "";
        
        if (isEditMode) grid.classList.add('edit-mode');
        else grid.classList.remove('edit-mode');

        installedApps.forEach((app, index) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'app-icon-wrapper';
            
            // Long Press Logic
            wrapper.addEventListener('mousedown', () => startLongPress(index));
            wrapper.addEventListener('touchstart', () => startLongPress(index));
            wrapper.addEventListener('mouseup', cancelLongPress);
            wrapper.addEventListener('touchend', cancelLongPress);
            wrapper.addEventListener('mouseleave', cancelLongPress);

            // Click Logic
            wrapper.onclick = (e) => handleAppClick(e, app.id, index);

            // Icon Visual
            let iconInner = '';
            let style = '';
            
            // Check if it's a store app (has image) or system app (font awesome)
            const storeData = storeApps.find(s => s.id === app.id);
            
            if (storeData && storeData.iconImg) {
                // Image based icon
                style = `background-image: url('${storeData.iconImg}'); background-color: white;`;
            } else if (storeData && storeData.iconIcon) {
                // Font awesome based store app
                iconInner = `<i class="${storeData.iconIcon}"></i>`;
                style = `background: ${storeData.bgColor || '#333'};`;
            } else {
                // System app
                iconInner = `<i class="fas ${app.icon}"></i>`;
            }

            // HTML Structure
            wrapper.innerHTML = `
                <div class="app-icon ${app.color || ''}" style="${style}">
                    ${iconInner}
                </div>
                <span class="app-name">${app.name}</span>
                <div class="delete-badge" onclick="deleteApp(event, ${index})"><i class="fas fa-times"></i></div>
                <div class="move-badge"><i class="fas fa-arrows-alt"></i></div>
            `;
            
            // Highlight if selected for swap
            if(selectedForSwap === index) {
                wrapper.querySelector('.app-icon').style.opacity = "0.5";
            }

            grid.appendChild(wrapper);
        });
    }

    /* --- EDIT MODE / LONG PRESS --- */
    function startLongPress(index) {
        editModeTimer = setTimeout(() => {
            isEditMode = true;
            renderHomeScreen();
            navigator.vibrate(50); // Haptic feedback
        }, 800);
    }
    
    function cancelLongPress() {
        clearTimeout(editModeTimer);
    }

    function handleAppClick(e, appId, index) {
        if (isEditMode) {
            // Swap Logic
            if (selectedForSwap === null) {
                selectedForSwap = index;
                renderHomeScreen(); // Update visual
            } else {
                // Swap array positions
                const temp = installedApps[selectedForSwap];
                installedApps[selectedForSwap] = installedApps[index];
                installedApps[index] = temp;
                selectedForSwap = null;
                saveSystem(); // Persist layout
                renderHomeScreen();
            }
        } else {
            openApp(appId);
        }
    }

    function deleteApp(e, index) {
        e.stopPropagation();
        const app = installedApps[index];
        // Prevent deleting core system apps
        const systemIds = defaultApps.map(a => a.id);
        if (systemIds.includes(app.id)) {
            showToast("Can't delete system app");
            return;
        }
        
        // QUICK DELETE: removed confirmation prompt
        installedApps.splice(index, 1);
        saveSystem();
        renderHomeScreen();
    }

    function exitEditMode() {
        isEditMode = false;
        selectedForSwap = null;
        renderHomeScreen();
    }

    /* --- NETWORK CHECK --- */
    function hasNetwork() {
        if (state.plane) return false;
        return state.wifi || state.data;
    }

    /* --- PLAY STORE LOGIC --- */
    function renderStore() {
        const container = document.getElementById('store-list-container');
        container.innerHTML = "";
        
        storeApps.forEach(app => {
            // Check status
            const isInstalled = installedApps.some(a => a.id === app.id);
            const isDownloading = activeDownloads[app.id] !== undefined;
            const dl = activeDownloads[app.id];

            let actionBtn = "";
            let progressHTML = "";

            if (isInstalled) {
                actionBtn = `<button class="store-action btn-play" onclick="openApp('${app.id}')">Open</button>`;
            } else if (isDownloading) {
                const p = Math.floor((dl.downloaded / app.sizeMB) * 100);
                const isPaused = dl.paused;
                actionBtn = `
                    <button class="store-action ${isPaused ? 'btn-install' : 'btn-pause'}" onclick="toggleDownload('${app.id}')">
                        ${isPaused ? 'Resume' : 'Pause'}
                    </button>
                    <button class="store-action btn-cancel" onclick="cancelDownload('${app.id}')">X</button>
                `;
                progressHTML = `
                    <div style="font-size:10px; color:#666; margin-top:4px;">${dl.downloaded.toFixed(1)}MB / ${app.sizeMB}MB (${p}%)</div>
                    <div class="progress-container" style="display:block;">
                        <div class="progress-bar" style="width: ${p}%"></div>
                    </div>
                `;
            } else {
                actionBtn = `<button class="store-action btn-install" onclick="startDownload('${app.id}')">Install</button>`;
            }

            const item = document.createElement('div');
            item.className = 'store-item';
            
            let iconSrc = app.iconImg ? `<img src="${app.iconImg}" class="store-icon">` 
                                      : `<div class="store-icon" style="display:flex; justify-content:center; align-items:center; background:${app.bgColor||'#333'}; color:white;"><i class="${app.iconIcon}"></i></div>`;

            item.innerHTML = `
                ${iconSrc}
                <div class="store-info">
                    <div class="store-title">${app.name}</div>
                    <div class="store-size">${app.sizeMB} MB</div>
                    ${progressHTML}
                </div>
                <div>${actionBtn}</div>
            `;
            container.appendChild(item);
        });
    }

    function startDownload(id) {
        if (!hasNetwork()) {
            showToast("No Internet Connection");
            return;
        }
        const app = storeApps.find(a => a.id === id);
        activeDownloads[id] = { downloaded: 0, paused: false, timer: null };
        resumeDownloadTimer(id);
        renderStore();
    }

    function toggleDownload(id) {
        const dl = activeDownloads[id];
        if (dl.paused) {
            if (!hasNetwork()) { showToast("No Internet Connection"); return; }
            dl.paused = false;
            resumeDownloadTimer(id);
        } else {
            dl.paused = true;
            clearInterval(dl.timer);
        }
        renderStore();
    }

    function cancelDownload(id) {
        clearInterval(activeDownloads[id].timer);
        delete activeDownloads[id];
        renderStore();
    }

    function resumeDownloadTimer(id) {
        const app = storeApps.find(a => a.id === id);
        const dl = activeDownloads[id];
        dl.timer = setInterval(() => {
            if (!hasNetwork()) {
                dl.paused = true;
                clearInterval(dl.timer);
                showToast("Network lost. Paused.");
                renderStore();
                return;
            }
            const chunk = (DOWNLOAD_SPEED_MBPS / 10) * (0.8 + Math.random() * 0.4); 
            dl.downloaded += chunk;
            if (dl.downloaded >= app.sizeMB) {
                clearInterval(dl.timer);
                delete activeDownloads[id];
                installApp(app);
            }
            if (document.getElementById('app-playstore').classList.contains('active')) {
                renderStore();
            }
        }, 100);
    }

    function installApp(appStoreData) {
        showToast(`Installed ${appStoreData.name}`);
        installedApps.push({
            id: appStoreData.id,
            name: appStoreData.name,
            icon: '', 
            color: ''
        });
        saveSystem();
        renderHomeScreen();
        if (document.getElementById('app-playstore').classList.contains('active')) {
            renderStore();
        }
    }

    /* --- APP OPENING LOGIC --- */
    function openApp(id) {
        if (isEditMode) { exitEditMode(); return; }
        document.getElementById('control-center').classList.remove('open');
        document.getElementById('recents-view').classList.remove('active');
        recentAppsList = recentAppsList.filter(appId => appId !== id);
        recentAppsList.push(id);
        saveSystem();

        const sysAppEl = document.getElementById('app-' + id);
        if (sysAppEl) {
            sysAppEl.classList.add('active');
            if(id === 'notepad') {
                const saved = localStorage.getItem('adv_note');
                if(saved) document.getElementById('note-input').value = saved;
            }
            if(id === 'camera') startCam();
            if(id === 'gallery') loadGallery();
            if(id === 'youtube') initYoutube();
            if(id === 'playstore') renderStore();
        } else {
            const storeData = storeApps.find(a => a.id === id);
            if (storeData) launchStoreApp(storeData);
        }
    }

    // UPDATED: LAG FIX FOR URA APP
    function launchStoreApp(data) {
        const frameWin = document.getElementById('app-generic-frame');
        const header = document.getElementById('generic-header');
        const content = document.getElementById('generic-content');
        
        frameWin.classList.add('active');
        header.innerText = data.name;
        
        if (data.type === 'intent') {
            content.innerHTML = `<div class="ff-launch-screen"><h3>Starting ${data.name}...</h3></div>`;
            window.location.href = "intent:#Intent;action=android.intent.action.MAIN;category=android.intent.category.LAUNCHER;package=com.dts.freefiremax;end;";
        } else {
            // Optimized: Don't reload if the URL is the same to reduce lag
            let existingIframe = content.querySelector('iframe');
            if (existingIframe) {
                if (existingIframe.src !== data.url) existingIframe.src = data.url;
            } else {
                content.innerHTML = `<iframe src="${data.url}" style="width:100%; height:100%; border:none;"></iframe>`;
            }
        }
    }

    /* --- GLOBAL CLOSING --- */
    function closeAllApps() {
        document.querySelectorAll('.app-window').forEach(w => w.classList.remove('active'));
        stopCam();
        endCall();
        document.getElementById('yt-player').src = "";
        document.getElementById('yt-player-box').style.display = "none";
        // Optimized: Don't clear content innerHTML to keep iframe warm, but stop games/videos
        const iframe = document.querySelector('#generic-content iframe');
        if(iframe) iframe.src = "about:blank"; 
        exitEditMode();
    }

    /* --- NETWORK STATE LISTENER --- */
    function toggleSetting(key) {
        if(key === 'plane') {
            state.plane = !state.plane;
            if(state.plane) { state.wifi = false; state.data = false; state.bt = false; }
        } else {
            if(state.plane && (key === 'wifi' || key === 'data' || key === 'bt')) state.plane = false;
            state[key] = !state[key];
        }
        updateUI();
        saveSystem();
        if (!hasNetwork()) {
            Object.keys(activeDownloads).forEach(id => {
                const dl = activeDownloads[id];
                if (!dl.paused) {
                    dl.paused = true;
                    clearInterval(dl.timer);
                }
            });
            if (Object.keys(activeDownloads).length > 0) showToast("Network lost. Downloads paused.");
            if (document.getElementById('app-playstore').classList.contains('active')) renderStore();
        }
    }
    
    function updateUI() {
        for(let k in state) {
            const btn = document.getElementById('btn-'+k);
            if(btn) {
                if(state[k]) btn.classList.add('active');
                else btn.classList.remove('active');
                if(k === 'flash') {
                    if(state.flash) btn.classList.add('torch-on');
                    else btn.classList.remove('torch-on');
                }
            }
        }
        document.getElementById('stat-wifi').classList.toggle('visible', state.wifi);
        document.getElementById('stat-data').classList.toggle('visible', state.data);
        document.getElementById('stat-plane').classList.toggle('visible', state.plane);
        document.getElementById('stat-bt').classList.toggle('visible', state.bt);
        const bolt = document.getElementById('stat-bolt');
        if(state.save) bolt.classList.add('visible');
        else bolt.classList.remove('visible');
    }

    /* --- STANDARD PHONE FUNCTIONS --- */
    const screenEl = document.getElementById('screen');
    const controlCenter = document.getElementById('control-center');
    
    screenEl.addEventListener('click', (e) => {
        if(controlCenter.classList.contains('open')) {
            const isCC = e.target.closest('.control-center');
            const isTrigger = e.target.closest('.status-bar');
            if(!isCC && !isTrigger) controlCenter.classList.remove('open');
        }

        // EXIT EDIT MODE ON TAP ANYWHERE
        if (isEditMode && !e.target.closest('.app-icon-wrapper')) {
            exitEditMode();
        }
    });

    const blackScreen = document.getElementById('black-screen');
    const homeScreen = document.getElementById('home-screen');

    homeScreen.addEventListener('dblclick', () => { lockPhone(); });
    blackScreen.addEventListener('dblclick', () => { wakePhone(); });

    function wakePhone() {
        if (blackScreen.style.display === 'block') {
            blackScreen.style.display = 'none';
            navHome();
            lockPhone();
        }
    }

    function lockPhone() {
        document.getElementById('lock-screen').classList.remove('unlocked');
        closePinPad();
    }

    function triggerRestart(isReset) {
        if(isReset) {
            showToast("Resetting...");
            setTimeout(() => { doBootSequence(true); }, 1000);
        } else {
            doBootSequence(false);
        }
    }

    function doBootSequence(isReset) {
        const boot = document.getElementById('boot-screen');
        const txt = document.getElementById('boot-text');
        txt.innerText = isReset ? "Erasing..." : "Restarting...";
        boot.style.display = 'flex';
        if(isReset) {
            localStorage.clear();
            galleryPhotos = [];
            state.systemPin = "2026";
            document.getElementById('note-input').value = "";
            installedApps = [...defaultApps];
            recentAppsList = [];
            activeDownloads = {};
            renderHomeScreen();
        }
        setTimeout(() => {
            boot.style.display = 'none';
            navHome();
            lockPhone();
        }, 4000);
    }

    function showToast(msg) {
        const toast = document.getElementById('toast-msg');
        toast.innerText = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    const swipeArea = document.getElementById('swipe-area');
    let startY = 0;
    swipeArea.addEventListener('mousedown', (e) => { startY = e.clientY; });
    document.addEventListener('mouseup', (e) => {
        if (startY > 0 && e.clientY - startY > 50) controlCenter.classList.add('open');
        startY = 0;
    });
    swipeArea.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; });
    swipeArea.addEventListener('touchend', (e) => {
        if (startY > 0 && e.changedTouches[0].clientY - startY > 50) controlCenter.classList.add('open');
        startY = 0;
    });
    document.querySelector('.fa-chevron-up').parentElement.addEventListener('click', () => {
         controlCenter.classList.remove('open');
    });

    const lockSwipeZone = document.getElementById('lock-swipe-zone');
    const lockMain = document.getElementById('lock-main');
    const lockPad = document.getElementById('lock-pad');
    let lockStartY = 0;
    lockSwipeZone.addEventListener('mousedown', (e) => lockStartY = e.clientY);
    lockSwipeZone.addEventListener('mouseup', (e) => {
        if (lockStartY > 0 && lockStartY - e.clientY > 50) openPinPad();
        lockStartY = 0;
    });
    lockSwipeZone.addEventListener('touchstart', (e) => lockStartY = e.touches[0].clientY);
    lockSwipeZone.addEventListener('touchend', (e) => {
        if (lockStartY > 0 && lockStartY - e.changedTouches[0].clientY > 50) openPinPad();
        lockStartY = 0;
    });

    function openPinPad() {
        lockMain.classList.add('slide-up');
        lockPad.classList.add('active');
    }
    function closePinPad() {
        lockMain.classList.remove('slide-up');
        lockPad.classList.remove('active');
        pin = "";
        updatePinDots();
    }

    function updateClock() {
        const now = new Date();
        const t = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const d = now.toLocaleDateString([], {weekday:'long', month:'short', day:'numeric'});
        document.getElementById('clock-small').innerText = t;
        document.getElementById('lock-time').innerText = t;
        document.getElementById('lock-date').innerText = d;
    }
    setInterval(updateClock, 1000);

    let pin = "";
    function pinIn(n) {
        if(blackScreen.style.display === 'block') { wakePhone(); return; }
        if (n === 'C') pin = pin.slice(0, -1);
        else if (n === 'CHECK') { checkPin(); return; }
        else if (pin.length < 4) pin += n;
        updatePinDots();
    }

    function updatePinDots() {
        for(let i=1; i<=4; i++) {
            const d = document.getElementById('p'+i);
            if(i <= pin.length) d.classList.add('filled');
            else d.classList.remove('filled');
        }
    }

    function checkPin() {
        if(pin === state.systemPin) {
            document.getElementById('lock-screen').classList.add('unlocked');
            closePinPad(); 
        } else {
            const pad = document.querySelector('.pin-dots');
            pad.classList.add('shake');
            setTimeout(() => pad.classList.remove('shake'), 400);
            pin = "";
            updatePinDots();
        }
    }

    function changeSystemPin() {
        const currInput = document.getElementById('curr-pin-val');
        const newInput = document.getElementById('new-pin-val');
        const currVal = currInput.value;
        const newVal = newInput.value;
        if (currVal !== state.systemPin) {
            showToast("Error: Incorrect Current PIN");
            return;
        }
        if(newVal.length === 4 && !isNaN(newVal)) {
            state.systemPin = newVal;
            saveSystem();
            showToast("PIN Changed Successfully!");
            currInput.value = "";
            newInput.value = "";
        } else {
            showToast("Error: New PIN must be 4 digits");
        }
    }

    let dialNum = "";
    let callTimerInt;
    let callSeconds = 0;
    let currentCallAudio = null;
    let ringOscillator = null;
    let ringGain = null;
    let ringInterval = null;
    let audioCtx = null;

    function dialKey(k) {
        if(k === 'DEL') dialNum = dialNum.slice(0, -1);
        else dialNum += k;
        document.getElementById('dial-number').innerText = dialNum;
    }
    function dialModi() {
        dialNum = "Modi Ji";
        document.getElementById('dial-number').innerText = dialNum;
        startCall();
    }
    function startCall() {
        if(state.plane) { showToast("No Network"); return; }
        const number = document.getElementById('dial-number').innerText;
        if(!number) return;
        
        // FIX: Force display of calling screen by toggling class AND style
        const incallScreen = document.getElementById('incall-screen');
        incallScreen.classList.add('active');
        incallScreen.style.display = 'flex'; // Override inline display:none
        
        document.getElementById('call-name').innerText = number;
        document.getElementById('call-status').innerText = "Calling...";
        
        if(number === "Modi Ji") {
            setTimeout(() => { pickUpCall('https://files.catbox.moe/34zxrk.mp3'); }, 5000);
        } else {
            startRing();
            setTimeout(() => { stopRing(); pickUpCall('https://files.catbox.moe/n9qxom.mp3'); }, 5000);
        }
    }
    function startRing() {
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            ringOscillator = audioCtx.createOscillator();
            ringGain = audioCtx.createGain();
            ringOscillator.type = "sine";
            ringOscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
            ringGain.gain.value = 0;
            ringOscillator.connect(ringGain);
            ringGain.connect(audioCtx.destination);
            ringOscillator.start();
            ringInterval = setInterval(() => {
                if(ringGain) {
                    ringGain.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    setTimeout(() => { if(ringGain) ringGain.gain.setValueAtTime(0, audioCtx.currentTime); }, 800);
                }
            }, 1600);
        } catch(e) { console.log("Ring failed", e); }
    }
    function stopRing() {
        clearInterval(ringInterval);
        if(ringOscillator) { try { ringOscillator.stop(); } catch(e){} }
        if(audioCtx) { try { audioCtx.close(); } catch(e){} }
    }
    function pickUpCall(audioUrl) {
        const incallScreen = document.getElementById('incall-screen');
        const status = document.getElementById('call-status');
        
        // Ensure call is still active
        if(!incallScreen.classList.contains('active')) return;
        
        status.innerText = "00:00";
        callSeconds = 0;
        
        // Start Timer
        callTimerInt = setInterval(() => {
            callSeconds++;
            const m = Math.floor(callSeconds / 60).toString().padStart(2, '0');
            const s = (callSeconds % 60).toString().padStart(2, '0');
            status.innerText = `${m}:${s}`;
        }, 1000);
        
        // Play Audio with Error Handling
        try {
            currentCallAudio = new Audio(audioUrl);
            currentCallAudio.play().catch(e => {
                console.log("Autoplay blocked or URL failed", e);
                // Timer continues running even if audio fails
            });
            currentCallAudio.onended = function() { endCall(); };
        } catch(e) { console.log(e); }
    }
    function endCall() {
        if(currentCallAudio) { currentCallAudio.pause(); currentCallAudio = null; }
        stopRing();
        clearInterval(callTimerInt);
        
        const incallScreen = document.getElementById('incall-screen');
        incallScreen.classList.remove('active');
        incallScreen.style.display = 'none'; // Re-hide
        
        dialNum = "";
        document.getElementById('dial-number').innerText = "";
    }

    function navHome() {
        if(blackScreen.style.display === 'block') { wakePhone(); return; }
        closeAllApps();
        document.getElementById('recents-view').classList.remove('active');
        document.getElementById('control-center').classList.remove('open');
    }

    // UPDATED: SMART BACK BUTTON LOGIC
    function navBack() {
        if(blackScreen.style.display === 'block') { wakePhone(); return; }
        const activeApp = document.querySelector('.app-window.active');
        
        if (activeApp) {
            const appId = activeApp.id;

            // 1. If in Phone App
            if (appId === 'app-phone') {
                if (document.getElementById('incall-screen').classList.contains('active')) { endCall(); return; }
                if (dialNum.length > 0) { dialNum = ""; document.getElementById('dial-number').innerText = ""; return; }
                navHome(); return;
            }

            // 2. If in YouTube App
            if (appId === 'app-youtube') {
                const playerBox = document.getElementById('yt-player-box');
                if (playerBox.style.display === 'block') { document.getElementById('yt-player').src = ""; playerBox.style.display = 'none'; return; }
                navHome(); return;
            }

            // 3. IF IN STORE APP (LIKE URA) OR BROWSER/CHROME
            // This attempts to navigate back inside the iframe history
            const targetIframe = activeApp.querySelector('iframe') || activeApp.querySelector('embed');
            if (targetIframe && (appId === 'app-generic-frame' || appId === 'app-browser' || appId === 'app-chrome')) {
                try {
                    // Try to trigger the iframe's internal back history
                    targetIframe.contentWindow.history.back();
                    return; // Stays inside the app as requested
                } catch(e) {
                    // If CORS prevents history access, we still stay in the app
                    // but most GitHub pages apps (like URA) will handle history internally
                    console.log("Internal nav triggered");
                    return;
                }
            }

            // 4. For everything else, go home
            navHome();
        }
        document.getElementById('recents-view').classList.remove('active');
    }

    function navRecents() {
        if(blackScreen.style.display === 'block') { wakePhone(); return; }
        closeAllApps();
        const view = document.getElementById('recents-view');
        view.classList.add('active');
        view.innerHTML = "";
        if(recentAppsList.length === 0) {
            view.innerHTML = "<p style='color:white;width:100%;text-align:center;pointer-events:none;'>No Recent Apps</p>";
            return;
        }
        [...recentAppsList].reverse().forEach(appId => {
            let appData = installedApps.find(a => a.id === appId);
            if(!appData) appData = storeApps.find(a => a.id === appId);
            if(!appData) appData = { name: 'Unknown', icon: 'fa-question' };
            let iconHtml = '';
            if(appData.iconImg) iconHtml = `<img src="${appData.iconImg}" style="width:30px; height:30px; border-radius:5px;">`;
            else if (appData.icon && appData.icon.startsWith('http')) iconHtml = `<img src="${appData.icon}" style="width:30px; height:30px;">`; 
            else iconHtml = `<i class="fas ${appData.icon || 'fa-window-maximize'}"></i>`;
            const card = document.createElement('div');
            card.className = 'recent-card';
            card.id = `card-${appId}`;
            card.innerHTML = `
                <div class="close-recent" onclick="removeRecent(event, '${appId}')"><i class="fas fa-times"></i></div>
                <div class="recent-header">${iconHtml} ${appData.name}</div>
                <div class="recent-body" onclick="openApp('${appId}')">${iconHtml.replace('30px','60px')}</div>
            `;
            view.appendChild(card);
        });
    }
    function checkRecentsClick(e) { if(recentAppsList.length === 0) navHome(); }
    function removeRecent(e, appId) {
        e.stopPropagation();
        const card = document.getElementById(`card-${appId}`);
        card.classList.add('slide-up-remove');
        setTimeout(() => {
            recentAppsList = recentAppsList.filter(id => id !== appId);
            saveSystem();
            navRecents();
        }, 300);
    }

    function saveNote() {
        localStorage.setItem('adv_note', document.getElementById('note-input').value);
        showToast("Saved!");
    }

    const ytVideos = [
        { id: 'dQw4w9WgXcQ', title: 'Rick Astley - Never Gonna Give You Up', author: 'Rick Astley', views: '1.4B views' },
        { id: 'jNQXAC9IVRw', title: 'Me at the zoo', author: 'jawed', views: '300M views' },
        { id: '9bZkp7q19f0', title: 'PSY - GANGNAM STYLE', author: 'officialpsy', views: '5.1B views' },
        { id: 'CevxZvSJLk8', title: 'Roar - Katy Perry', author: 'Katy Perry', views: '3.9B views' },
        { id: 'kJQP7kiw5Fk', title: 'Despacito - Luis Fonsi', author: 'Luis Fonsi', views: '8.3B views' },
        { id: 'fRh_vgS2dFE', title: 'Sorry - Justin Bieber', author: 'Justin Bieber', views: '3.7B views' }
    ];
    function initYoutube() {
        const feed = document.getElementById('yt-feed');
        feed.innerHTML = "";
        ytVideos.forEach(v => {
            const item = document.createElement('div');
            item.className = 'yt-item';
            item.style.marginBottom = '8px'; item.style.background = 'white'; item.style.cursor = 'pointer';
            item.onclick = () => playYoutube(v.id);
            item.innerHTML = `
                <img class="yt-thumb" src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg" style="width: 100%; aspect-ratio: 16/9; display: block; object-fit: cover;">
                <div class="yt-info" style="padding: 10px; display: flex; gap: 10px;">
                    <div class="yt-avatar" style="width: 36px; height: 36px; border-radius: 50%; background: #ccc; flex-shrink: 0;"></div>
                    <div class="yt-text" style="display: flex; flex-direction: column;">
                        <div class="yt-title" style="font-size: 14px; font-weight: 600; color: #0f0f0f; margin-bottom: 2px;">${v.title}</div>
                        <div class="yt-meta" style="font-size: 12px; color: #606060;">${v.author}  ${v.views}</div>
                    </div>
                </div>
            `;
            feed.appendChild(item);
        });
    }
    function playYoutube(id) {
        const playerBox = document.getElementById('yt-player-box');
        const player = document.getElementById('yt-player');
        playerBox.style.display = 'block';
        player.src = `https://www.youtube.com/embed/${id}?autoplay=1`;
        document.getElementById('yt-feed').scrollTop = 0;
    }

    let stream;
    function startCam() {
        if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({video:true}).then(s => {
                stream = s;
                document.getElementById('cam-feed').srcObject = s;
            }).catch(e => console.log(e));
        }
    }
    function stopCam() { if(stream) stream.getTracks().forEach(t => t.stop()); }
    function snap() {
        const video = document.getElementById('cam-feed');
        const canvas = document.getElementById('cam-canvas');
        const ctx = canvas.getContext('2d');
        video.style.opacity = 0; setTimeout(()=>video.style.opacity=1, 150);
        canvas.width = video.videoWidth || 300; canvas.height = video.videoHeight || 400;
        if(video.srcObject) ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        else { ctx.fillStyle = "black"; ctx.fillRect(0,0, canvas.width, canvas.height); }
        galleryPhotos.push(canvas.toDataURL('image/png'));
        saveSystem();
    }
    function loadGallery() {
        const container = document.getElementById('gallery-container');
        container.innerHTML = "";
        if(galleryPhotos.length === 0) { container.innerHTML = "<p style='text-align:center; grid-column:span 3; padding:20px; color:#999'>No Photos</p>"; return; }
        galleryPhotos.forEach((src, index) => {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.style.position='relative'; item.style.height='100px';
            const img = document.createElement('img');
            img.src = src; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
            const btn = document.createElement('div');
            btn.className = 'delete-photo';
            btn.innerHTML = '<i class="fas fa-trash"></i>';
            btn.style.position='absolute'; btn.style.top='5px'; btn.style.right='5px'; btn.style.width='20px'; btn.style.height='20px'; btn.style.background='rgba(255,0,0,0.8)'; btn.style.color='white'; btn.style.borderRadius='50%'; btn.style.display='flex'; btn.style.justifyContent='center'; btn.style.alignItems='center'; btn.style.fontSize='10px'; btn.style.cursor='pointer';
            btn.onclick = function() { deletePhoto(index); };
            item.appendChild(img); item.appendChild(btn); container.appendChild(item);
        });
    }
    function deletePhoto(index) { galleryPhotos.splice(index, 1); saveSystem(); loadGallery(); }

    function loadBrowser() {
        let url = document.getElementById('browser-url').value;
        if(!url.startsWith('http')) url = 'https://' + url;
        document.getElementById('browser-frame').src = url;
    }
    function searchGoogle() {
        let val = document.getElementById('chrome-search-input').value;
        document.getElementById('chrome-frame').src = "https://www.google.com/search?q=" + encodeURIComponent(val) + "&igu=1";
    }

    let cExp = "";
    function calc(v) {
        if(v==='C') cExp = "";
        else if(v==='DEL') cExp = cExp.slice(0,-1);
        else if(v==='=') { try { cExp = eval(cExp).toString() } catch { cExp="Error"} }
        else cExp += v;
        document.getElementById('calc-display').innerText = cExp || "0";
    }
</script>
</body>
</html>